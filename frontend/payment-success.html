<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d0f1a">
    <title>Payment Processing - SHIOL+</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        canvas: {
                            DEFAULT: '#0d0f1a',
                            card: '#141726',
                            surface: '#1a1f33',
                            line: 'rgba(255,255,255,0.08)',
                            accent: '#00e0ff',
                            accent2: '#ff4d6d',
                            success: '#22c55e'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Dark Theme CSS -->
    <link rel="stylesheet" href="css/dark-theme.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #00e0ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .success-checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #22c55e;
            stroke-miterlimit: 10;
            margin: 10% auto;
            box-shadow: inset 0px 0px 0px #22c55e;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        
        .success-checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #22c55e;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        
        .success-checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }
        
        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
        
        @keyframes scale {
            0%, 100% { transform: none; }
            50% { transform: scale3d(1.1, 1.1, 1); }
        }
        
        @keyframes fill {
            100% { box-shadow: inset 0px 0px 0px 30px #22c55e; }
        }
    </style>
</head>
<body class="bg-canvas text-white min-h-screen flex items-center justify-center antialiased">
    <div class="max-w-md w-full mx-auto p-6">
        <!-- Processing State -->
        <div id="processing-state" class="text-center">
            <div class="spinner mx-auto mb-6"></div>
            <h1 class="text-2xl font-bold mb-4 pulse-animation">Confirming your payment...</h1>
            <p class="text-gray-300 mb-6">
                Please wait while we process your payment and activate your Premium access.
            </p>
            <div class="text-sm text-gray-300">
                This usually takes a few seconds.
            </div>
        </div>
        
        <!-- Success State -->
        <div id="success-state" class="text-center hidden">
            <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="success-checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="success-checkmark__check" fill="none" d="m14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
            
            <h1 class="text-2xl font-bold text-canvas-success mb-4">Payment Successful!</h1>
            <p class="text-white/80 mb-6">
                Welcome to SHIOL+ Premium! Your account has been upgraded and you now have access to all 200 AI insights.
            </p>
            
            <div class="bg-canvas-success/10 border border-canvas-success/30 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-canvas-success mb-2">Premium Features Activated:</h3>
                <ul class="text-sm text-white/80 space-y-1">
                    <li><i class="fas fa-check text-canvas-success mr-2"></i>Access to all 200 AI insights</li>
                    <li><i class="fas fa-check text-canvas-success mr-2"></i>Unlimited ticket verifications</li>
                    <li><i class="fas fa-check text-canvas-success mr-2"></i>Advanced statistics and insights</li>
                    <li><i class="fas fa-check text-canvas-success mr-2"></i>Priority support</li>
                </ul>
            </div>
            
            <button 
                id="dashboard-button"
                onclick="goToDashboard()" 
                class="w-full bg-gradient-to-r from-canvas-accent to-canvas-accent2 hover:opacity-90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-200"
            >
                <i class="fas fa-chart-line mr-2"></i>
                <span id="button-text">View Your AI Insights</span>
            </button>
            
            <p class="text-sm text-white/60 mt-3 text-center">
                You will be redirected automatically in <span id="countdown">5</span> seconds...
            </p>
        </div>
        
        <!-- Error State -->
        <div id="error-state" class="text-center hidden">
            <div class="text-canvas-accent2 mb-6">
                <i class="fas fa-exclamation-triangle text-4xl"></i>
            </div>
            
            <h1 class="text-2xl font-bold text-canvas-accent2 mb-4">Payment Verification Taking Longer</h1>
            <p class="text-white/80 mb-6">
                We're still processing your payment. This can take up to a few minutes.
            </p>
            
            <div class="bg-canvas-accent2/10 border border-canvas-accent2/30 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-canvas-accent2 mb-2">What you can do:</h3>
                <ul class="text-sm text-white/80 space-y-2">
                    <li><i class="fas fa-refresh text-canvas-accent2 mr-2"></i>Refresh this page in a minute</li>
                    <li><i class="fas fa-home text-canvas-accent2 mr-2"></i>Return to the main page and check your status</li>
                    <li><i class="fas fa-envelope text-canvas-accent2 mr-2"></i>Check your email for payment confirmation</li>
                </ul>
            </div>
            
            <div class="space-y-3">
                <button 
                    onclick="location.reload()" 
                    class="w-full bg-gradient-to-r from-canvas-accent to-canvas-accent2 hover:opacity-90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-200"
                >
                    <i class="fas fa-refresh mr-2"></i>
                    Refresh Page
                </button>
                
                <button 
                    onclick="goToDashboard()" 
                    class="w-full bg-canvas-surface border border-canvas-line hover:bg-canvas-surface/80 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200"
                >
                    <i class="fas fa-home mr-2"></i>
                    Return to Dashboard
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="mt-8 pt-6 border-t border-canvas-line text-center">
            <p class="text-sm text-white/60">
                Need help? Contact us at 
                <a href="mailto:support@shiol.app" class="text-canvas-accent hover:text-canvas-accent/80 transition-colors">support@shiol.app</a>
            </p>
        </div>
    </div>

    <script>
        // Payment status checking logic
        let pollCount = 0;
        const maxPolls = 15; // 15 attempts over 30 seconds
        const pollInterval = 2000; // 2 seconds
        
        function goToDashboard() {
            window.location.href = '/';
        }
        
        async function checkPaymentStatus() {
            try {
                // Get session_id from URL
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('session_id');
                
                // Build URL with session_id parameter for direct Stripe verification
                let statusUrl = '/api/v1/billing/status';
                if (sessionId) {
                    statusUrl += `?session_id=${encodeURIComponent(sessionId)}`;
                }
                
                const response = await fetch(statusUrl, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Status endpoint response:', data);
                    
                    if (data.enabled && data.is_premium) {
                        // Payment confirmed! Now activate premium to set cookie
                        console.log('Payment confirmed, activating premium pass...');
                        
                        try {
                            const activateResponse = await fetch('/api/v1/billing/activate-premium', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'include',
                                body: JSON.stringify({ session_id: sessionId })
                            });
                            
                            if (activateResponse.ok) {
                                console.log('Premium pass activated and cookie set');
                            } else {
                                console.warn('Premium verified but cookie activation failed, will retry on next visit');
                            }
                        } catch (activateError) {
                            console.error('Error activating premium pass:', activateError);
                            // Continue anyway - the important part is that premium is verified
                        }
                        
                        showSuccessState();
                        return true;
                    }
                }
                
                return false;
                
            } catch (error) {
                console.error('Error checking payment status:', error);
                return false;
            }
        }

        // Proactively attempt activation immediately when landing on the page.
        // This verifies the Stripe session on the server and sets the cookie without
        // waiting for the status polling to infer premium.
        async function tryActivatePremium(sessionId) {
            if (!sessionId) return false;
            try {
                console.log('Attempting immediate premium activation...');
                const resp = await fetch('/api/v1/billing/activate-premium', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ session_id: sessionId })
                });
                if (resp.ok) {
                    const data = await resp.json();
                    console.log('Immediate activation successful:', data);
                    showSuccessState();
                    return true;
                } else {
                    const err = await resp.json().catch(() => ({}));
                    console.log('Immediate activation not yet complete:', err?.detail || resp.statusText);
                    return false;
                }
            } catch (e) {
                console.log('Immediate activation attempt failed (will fall back to polling):', e.message);
                return false;
            }
        }
        
        function showSuccessState() {
            document.getElementById('processing-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('success-state').classList.remove('hidden');
            
            // Start countdown after showing success state
            startCountdown();
        }
        
        function startCountdown() {
            let timeLeft = 5;
            const countdownElement = document.getElementById('countdown');
            const buttonTextElement = document.getElementById('button-text');
            
            // Update countdown every second
            const countdownInterval = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    
                    // Change button text to show redirection
                    buttonTextElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Redirecting to Dashboard...';
                    
                    // Redirect after a short delay
                    setTimeout(() => {
                        goToDashboard();
                    }, 500);
                }
            }, 1000);
        }
        
        function showErrorState() {
            document.getElementById('processing-state').classList.add('hidden');
            document.getElementById('success-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
        }
        
        async function pollPaymentStatus() {
            pollCount++;
            
            console.log(`Checking payment status (attempt ${pollCount}/${maxPolls})...`);
            
            const isConfirmed = await checkPaymentStatus();
            
            if (isConfirmed) {
                console.log('Payment confirmed!');
                return;
            }
            
            if (pollCount >= maxPolls) {
                console.log('Max polling attempts reached, showing error state');
                showErrorState();
                return;
            }
            
            // Continue polling
            setTimeout(pollPaymentStatus, pollInterval);
        }
        
        // Start polling when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Payment success page loaded, starting status polling...');
            
            // Extract session_id from URL if available for logging
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            
            if (sessionId) {
                console.log('Stripe session ID:', sessionId);
                // First, try to activate immediately (idempotent on server)
                tryActivatePremium(sessionId).then((activated) => {
                    if (!activated) {
                        // Start polling after a short delay if immediate activation didn't finish
                        setTimeout(pollPaymentStatus, 1000);
                    }
                });
                return; // prevent double scheduling below
            }
            
            // Start polling after a short delay
            setTimeout(pollPaymentStatus, 1000);
        });
    </script>
</body>
</html>